<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bichito Aventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #fff;
        }
        
        #gameContainer {
            text-align: center;
        }
        
        canvas {
            border: 4px solid #0f3460;
            background: #87ceeb;
            display: block;
            margin: 20px auto;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #controls {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .control-row {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .key {
            background: #0f3460;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            border: 2px solid #e94560;
        }
        
        h1 {
            color: #e94560;
            margin-bottom: 10px;
        }
        
        #score {
            font-size: 24px;
            color: #00ff00;
            margin: 10px 0;
        }

        #debug {
            background: #0f3460;
            padding: 10px;
            border-radius: 5px;
            margin: 10px auto;
            max-width: 600px;
            font-size: 12px;
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>üéÆ BICHITO AVENTURE</h1>
        <div id="score">Score: 0</div>
        <div id="debug">Cargando...</div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="controls">
            <h3>‚å®Ô∏è CONTROLES</h3>
            <div class="control-row">
                <span class="key">‚Üê A / ‚Üê</span>
                <span class="key">‚Üí D / ‚Üí</span>
                <span class="key">‚Üë W / ‚Üë SALTAR</span>
                <span class="key">SPACE DISPARAR</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const debugEl = document.getElementById('debug');
        
        // Configuraci√≥n del juego
        const GRAVITY = 0.6;
        const JUMP_FORCE = -12;
        const MOVE_SPEED = 5;
        const GROUND_Y = canvas.height - 100;
        
        // URLs de GitHub - Tus sprites
        const GITHUB_BASE = 'https://raw.githubusercontent.com/kabertpro/bichito_aventure/main/assets/sprites/';
        
        const imageUrls = {
            idle: GITHUB_BASE + 'player_idle.png',
            run1: GITHUB_BASE + 'player_run.png',
            run2: GITHUB_BASE + 'player_run2.png',
            jump: GITHUB_BASE + 'player_jump.png',
            shoot: GITHUB_BASE + 'player_shoot.png',
            bullet: GITHUB_BASE + 'bullet.png',
            tileset: 'https://raw.githubusercontent.com/kabertpro/bichito_aventure/main/assets/tiles/tileset.png'
        };
        
        // Sistema de carga de im√°genes
        const images = {};
        let imagesLoaded = 0;
        const totalImages = Object.keys(imageUrls).length;
        
        // Cargar im√°genes
        Object.keys(imageUrls).forEach(key => {
            images[key] = new Image();
            images[key].crossOrigin = "anonymous";
            images[key].src = imageUrls[key];
            images[key].onload = () => {
                imagesLoaded++;
                debugEl.textContent = `Cargando im√°genes: ${imagesLoaded}/${totalImages}`;
                if (imagesLoaded === totalImages) {
                    debugEl.textContent = `‚úì Todas las im√°genes cargadas | Controles activos`;
                    startGame();
                }
            };
            images[key].onerror = () => {
                console.error(`Error cargando: ${key} - ${imageUrls[key]}`);
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    debugEl.textContent = `‚ö† Algunas im√°genes no cargaron | Juego iniciado con placeholders`;
                    startGame();
                }
            };
        });
        
        // Jugador
        const player = {
            x: 100,
            y: GROUND_Y,
            width: 80,
            height: 80,
            velocityY: 0,
            velocityX: 0,
            isJumping: false,
            isShooting: false,
            direction: 1,
            currentAnimation: 'idle',
            animFrame: 0,
            frameTimer: 0,
            frameDelay: 10
        };
        
        // Balas
        const bullets = [];
        const bulletSpeed = 10;
        let shootCooldown = 0;
        
        // Controles - FIX: usar keyup correctamente
        const keys = {};
        
        // Score
        let score = 0;
        
        // Plataformas usando el tileset
        const platforms = [
            { x: 0, y: GROUND_Y + 64, width: canvas.width, height: 40 },
            { x: 250, y: GROUND_Y - 80, width: 200, height: 30 },
            { x: 500, y: GROUND_Y - 160, width: 180, height: 30 },
            { x: 100, y: GROUND_Y - 240, width: 150, height: 30 }
        ];
        
        // Event Listeners - FIX CR√çTICO
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = true;
            
            // Disparar
            if (e.code === 'Space' && shootCooldown === 0) {
                shoot();
                e.preventDefault();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            keys[key] = false; // FIX: Antes dec√≠a true
        });
        
        function shoot() {
            bullets.push({
                x: player.direction === 1 ? player.x + player.width : player.x,
                y: player.y + player.height / 2,
                direction: player.direction,
                width: 40,
                height: 20
            });
            player.isShooting = true;
            player.currentAnimation = 'shoot';
            shootCooldown = 30;
            setTimeout(() => {
                player.isShooting = false;
            }, 200);
        }
        
        function updatePlayer() {
            // Movimiento horizontal
            let moving = false;
            
            if (keys['a'] || keys['arrowleft']) {
                player.velocityX = -MOVE_SPEED;
                player.direction = -1;
                moving = true;
            } else if (keys['d'] || keys['arrowright']) {
                player.velocityX = MOVE_SPEED;
                player.direction = 1;
                moving = true;
            } else {
                player.velocityX = 0;
            }
            
            // Saltar
            if ((keys['w'] || keys['arrowup']) && !player.isJumping) {
                player.velocityY = JUMP_FORCE;
                player.isJumping = true;
                player.currentAnimation = 'jump';
            }
            
            // Determinar animaci√≥n
            if (player.isShooting) {
                player.currentAnimation = 'shoot';
            } else if (player.isJumping) {
                player.currentAnimation = 'jump';
            } else if (moving) {
                player.currentAnimation = 'run';
            } else {
                player.currentAnimation = 'idle';
            }
            
            // Aplicar gravedad
            player.velocityY += GRAVITY;
            player.x += player.velocityX;
            player.y += player.velocityY;
            
            // Colisi√≥n con el suelo
            if (player.y >= GROUND_Y) {
                player.y = GROUND_Y;
                player.velocityY = 0;
                player.isJumping = false;
            }
            
            // Colisi√≥n con plataformas
            platforms.forEach(platform => {
                if (player.velocityY > 0 &&
                    player.x + player.width > platform.x &&
                    player.x < platform.x + platform.width &&
                    player.y + player.height >= platform.y &&
                    player.y + player.height <= platform.y + 20) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    player.isJumping = false;
                }
            });
            
            // L√≠mites del canvas
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
            
            // Cooldown de disparo
            if (shootCooldown > 0) shootCooldown--;
            
            // Actualizar frame de animaci√≥n
            player.frameTimer++;
            if (player.frameTimer >= player.frameDelay) {
                player.frameTimer = 0;
                player.animFrame = (player.animFrame + 1) % 2;
            }
        }
        
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].x += bulletSpeed * bullets[i].direction;
                
                // Eliminar balas fuera de pantalla
                if (bullets[i].x < 0 || bullets[i].x > canvas.width) {
                    bullets.splice(i, 1);
                    score += 10;
                    document.getElementById('score').textContent = `Score: ${score}`;
                }
            }
        }
        
        function drawPlayer() {
            ctx.save();
            
            let img;
            
            // Seleccionar imagen seg√∫n animaci√≥n
            switch(player.currentAnimation) {
                case 'idle':
                    img = images.idle;
                    break;
                case 'run':
                    img = player.animFrame === 0 ? images.run1 : images.run2;
                    break;
                case 'jump':
                    img = images.jump;
                    break;
                case 'shoot':
                    img = images.shoot;
                    break;
                default:
                    img = images.idle;
            }
            
            // Flip horizontal si mira a la izquierda
            if (player.direction === -1) {
                ctx.translate(player.x + player.width, player.y);
                ctx.scale(-1, 1);
                if (img && img.complete) {
                    ctx.drawImage(img, 0, 0, player.width, player.height);
                } else {
                    ctx.fillStyle = '#ff6b00';
                    ctx.fillRect(0, 0, player.width, player.height);
                }
            } else {
                if (img && img.complete) {
                    ctx.drawImage(img, player.x, player.y, player.width, player.height);
                } else {
                    ctx.fillStyle = '#ff6b00';
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                }
            }
            
            ctx.restore();
        }
        
        function drawBullets() {
            bullets.forEach(bullet => {
                if (images.bullet && images.bullet.complete) {
                    ctx.drawImage(images.bullet, bullet.x, bullet.y, bullet.width, bullet.height);
                } else {
                    ctx.fillStyle = '#ffff00';
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
        }
        
        function drawPlatforms() {
            platforms.forEach(platform => {
                // Usar tileset si est√° disponible
                if (images.tileset && images.tileset.complete) {
                    // Dibujar tiles repetidos
                    const tileSize = 64;
                    for (let x = 0; x < platform.width; x += tileSize) {
                        ctx.drawImage(
                            images.tileset,
                            0, 0, 128, 128,
                            platform.x + x, platform.y,
                            Math.min(tileSize, platform.width - x), platform.height
                        );
                    }
                } else {
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.strokeStyle = '#654321';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
                }
            });
        }
        
        function gameLoop() {
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Actualizar
            updatePlayer();
            updateBullets();
            
            // Dibujar
            drawPlatforms();
            drawPlayer();
            drawBullets();
            
            requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            console.log('Juego iniciado');
            gameLoop();
        }
        
        // Mensaje inicial
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('üéÆ Cargando Bichito Aventure...', canvas.width / 2, canvas.height / 2);
    </script>
</body>
</html>
